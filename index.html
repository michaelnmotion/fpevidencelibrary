<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Functional Patterns | Results Library</title>
  <meta name="description" content="Filter Functional Patterns results by condition, body part, age, and gender to preview Instagram posts like yours." />
  <style>
    :root { --bg:#0b0f10; --card:#11181c; --muted:#8aa0a9; --text:#e6eef2; --accent:#06b6d4; --border:#0f1417; }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    a { color:var(--accent); text-decoration:none; } a:hover { text-decoration:underline; }
    .wrap { max-width:1200px; margin:0 auto; padding:24px; }
    header { margin-bottom:16px; }
    h1 { font-size:28px; margin:0; letter-spacing:.2px; }
    .kicker { color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.14em; margin-top:6px; font-size:12px; }
    .sub { color:var(--muted); margin-top:10px; line-height:1.55; }

    /* Filters (compact / sleek) */
    .filters { display:grid; grid-template-columns:1fr; gap:12px; margin:16px 0; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .row { display:grid; grid-template-columns:repeat(12, minmax(0,1fr)); gap:12px; }
    .group { display:flex; flex-direction:column; gap:8px; grid-column: span 3 / span 3; }
    .group.span6 { grid-column: span 6 / span 6; }
    .group.span12 { grid-column: 1 / -1; }
    .label { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }
    select, input[type="text"] { width:100%; padding:10px 12px; border-radius:12px; background:#0e1418; color:var(--text); border:1px solid #142027; outline:none; }
    select:focus, input[type="text"]:focus { border-color:var(--accent); }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn { appearance:none; border:1px solid #1b2a30; background:#0e1418; color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer; font-size:13px; }
    .btn:hover { border-color:var(--accent); }
    .size { width:auto; }

    
    /* --- Compact density tweaks --- */
    .card { padding:10px; border-radius:14px; }
    .filters { position: sticky; top:0; z-index:60; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
    .row { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap:8px; align-items:center; }
    .group { gap:4px; }
    .label { font-size:10px; letter-spacing:.12em; opacity:.8; }
    select, input[type="text"] { padding:8px 10px; border-radius:10px; font-size:13px; min-height:36px; }
    .actions { justify-content:flex-end; gap:6px; }
    .btn { padding:6px 10px; border-radius:10px; font-size:12px; }
    .size { padding:6px 8px; min-height:32px; }
    header { margin-bottom:10px; }
    .kicker { margin-top:4px; }
    .sub { margin-top:8px; }
    @media (min-width: 769px){
      .group.span6 { grid-column: span 2 / span 2; }
      .group.span12 { grid-column: 1 / -1; }
    }
    @media (max-width: 768px){
      .actions .label { display:none; }
    }

    /* Grid of embeds */
    .grid-wrap { background:var(--card); border:1px solid var(--border); border-radius:16px; }
    .grid-header { display:flex; gap:8px; align-items:center; padding:12px; border-bottom:1px solid var(--border); color:var(--muted); }
    .counter { font-weight:600; color:#d8e6ed; }

    .grid { padding:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; }
    .embed-card { background:#0e1418; border:1px solid #162129; border-radius:14px; padding:10px; }
    .embed-card blockquote { width:100% !important; margin:0 auto !important; min-height:380px; }
    .pag { display:flex; gap:8px; align-items:center; padding:12px; border-top:1px solid var(--border); }
    .pag .btn { padding:6px 10px; }

    /* Footer */
    .site-footer { border-top:1px solid var(--border); margin-top:22px; color:var(--muted); font-size:12px; }
    .site-footer p { margin:14px 0; line-height:1.55; }

    /* Mobile */
    /* Mobile (two-column filter grid) */
    @media (max-width: 768px){
      /* two columns for the filter groups */
      .row { 
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        align-items: center;
      }

      /* each group is one column by default */
      .group { grid-column: auto; }

      /* search + actions span both columns */
      .group.span6,
      .group.span12 { grid-column: 1 / -1; }

      /* keep labels compact in the actions row */
      .actions .label { display: none; }

      /* embeds stay single-column on mobile */
      .grid { grid-template-columns: 1fr; }
      .embed-card blockquote { min-height: 360px; }
    }

    /* Extra-narrow safety: stack to one column below ~380px */
    @media (max-width: 380px){
      .row { grid-template-columns: 1fr; }
    }
  </style>

  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Instagram embed script (must be after the content is on the page; we'll call process() after rendering) -->
  <script async src="https://www.instagram.com/embed.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Functional Patterns Evidence</h1>
      <div class="kicker">Results Library</div>
      <div class="sub">
        Results are scraped from the <a href="https://www.instagram.com/fp.evidence/" target="_blank" rel="noopener"><strong>@fp.evidence</strong></a> page. This is by no means an exhaustive list of Functional Patterns outcomes.
        Use the filters below to preview matching Instagram posts — by condition, body part, age, and gender.
      </div>
    </header>

    <!-- Filters -->
    <section class="card filters">
      <div class="row">
        <div class="group">
          <div class="label">Gender</div>
          <select id="genderSelect">
            <option value="">All</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="unknown">Unknown / Blank</option>
          </select>
        </div>
        <div class="group">
          <div class="label">Age range</div>
          <select id="ageSelect">
            <option value="">All ages</option>
            <option value="0-9">0–9</option>
            <option value="10-14">10–14</option>
            <option value="15-24">15–24</option>
            <option value="25-34">25–34</option>
            <option value="35-44">35–44</option>
            <option value="45-54">45–54</option>
            <option value="55-64">55–64</option>
            <option value="65-200">65+</option>
          </select>
        </div>
        <div class="group">
          <div class="label">Body part (single)</div>
          <select id="bodySelect">
            <option value="">All</option>
          </select>
        </div>
        <div class="group">
          <div class="label">Condition</div>
          <select id="conditionsSelect">
            <option value="">All</option>
          </select>
        </div>
        <div class="group span6">
          <div class="label">Search (caption, user)</div>
          <input type="text" id="searchInput" placeholder="Type to search…" />
        </div>
        <div class="group span12 actions">
          <button id="resetBtn" class="btn">Reset</button>
          <label class="label" style="text-transform:none; letter-spacing:0;">Per page</label>
          <select id="pageSize" class="size">
            <option value="6">6</option>
            <option value="9" selected>9</option>
            <option value="12">12</option>
            <option value="18">18</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Grid of Instagram embeds -->
    <section class="grid-wrap">
      <div class="grid-header">
        <div><span id="counter" class="counter">0</span> matching posts</div>
        <div id="pageInfo" class="sub" style="margin-left:auto;">Page 1 / 1</div>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="pag">
        <button id="prevBtn" class="btn">Prev</button>
        <button id="nextBtn" class="btn">Next</button>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <div class="wrap">
      <p><em>Passion project by <strong>Michael Vincent</strong>.</em> Age, gender, condition, and body‑part metadata were pieced together with the help of AI; errors may be present.</p>
    </div>
  </footer>

  <script>
    // ------ Utilities ------
    const parseNum = (v) => {
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : null;
    };
    const splitTags = (s) => {
      if (!s) return [];
      return String(s).split(/[;,]/).map(t => t.trim().toLowerCase()).filter(Boolean);
    };
    function inAgeBin(age, bin) {
      if (!bin) return true;
      const n = parseNum(age);
      if (n == null) return false;
      const [lo, hi] = bin.split('-').map(Number);
      return n >= lo && n <= hi;
    }
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ------ State ------
    let rawRows = [];
    let viewRows = [];
    let page = 1;
    let pageSize = 9;

    // ------ DOM refs ------
    const genderSelect = document.getElementById('genderSelect');
    const ageSelect = document.getElementById('ageSelect');
    const bodySelect = document.getElementById('bodySelect');
    const conditionsSelect = document.getElementById('conditionsSelect');
    const searchInput = document.getElementById('searchInput');
    const resetBtn = document.getElementById('resetBtn');
    const pageSizeSel = document.getElementById('pageSize');
    const counter = document.getElementById('counter');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const grid = document.getElementById('grid');

    // ------ CSV loading with fallbacks ------
    const candidatePaths = [
      'data.csv', './data.csv',
      'output_with_tags_v2.csv', './output_with_tags_v2.csv',
      'data/data.csv', './data/data.csv', '/data.csv'
    ];

    function loadCsvFromPath(pathIdx = 0) {
      if (pathIdx >= candidatePaths.length) {
        console.warn('CSV not found at expected paths.');
        return;
      }
      const path = candidatePaths[pathIdx];
      Papa.parse(path, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          if (!res.data || !res.data.length) { loadCsvFromPath(pathIdx + 1); return; }
          onCsvLoaded(res.data);
        },
        error: () => loadCsvFromPath(pathIdx + 1)
      });
    }

    function onCsvLoaded(rows) {
      rawRows = rows.map(r => {
        const gender = (r['gender'] || '').toString().trim().toLowerCase();
        const age = parseNum(r['age']);
        const conds = splitTags(r['condition']);
        const bodies = splitTags(r['body_part']);
        const postUrl = r['post_url'] && r['post_url'].trim() ? r['post_url'].trim() :
                        (r['shortcode'] ? `https://www.instagram.com/p/${r['shortcode'].trim()}/` : '');
        const username = r['username'] || '';
        const caption = r['caption'] || '';
        return {
          ...r,
          _gender: gender || (r['gender'] == null || r['gender'] === '' ? 'unknown' : ''),
          _age: age,
          _conds: new Set(conds),
          _bodies: new Set(bodies),
          _post: postUrl,
          _username: username.toString(),
          _caption: caption.toString()
        };
      });

      // Build select options from data
      const condSet = new Set();
      const bodySet = new Set();
      rawRows.forEach(r => { r._conds.forEach(c => condSet.add(c)); r._bodies.forEach(b => bodySet.add(b)); });
      const condOptions = Array.from(condSet).sort();
      const bodyOptions = Array.from(bodySet).sort();

      bodySelect.innerHTML = '<option value="">All</option>';
      conditionsSelect.innerHTML = '<option value="">All</option>';
      bodyOptions.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; bodySelect.appendChild(o); });
      condOptions.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; conditionsSelect.appendChild(o); });

      attachHandlers();
      applyFiltersAndRender();
    }

    loadCsvFromPath(0);

    // ------ Handlers ------
    function attachHandlers() {
      genderSelect.addEventListener('change', onFilterChange);
      ageSelect.addEventListener('change', onFilterChange);
      bodySelect.addEventListener('change', onFilterChange);
      conditionsSelect.addEventListener('change', onFilterChange);
      searchInput.addEventListener('input', onFilterChange);
      pageSizeSel.addEventListener('change', (e) => { pageSize = Number(e.target.value); page = 1; render(); });
      resetBtn.addEventListener('click', () => {
        genderSelect.value = '';
        ageSelect.value = '';
        bodySelect.value = '';
        conditionsSelect.value = '';
        searchInput.value = '';
        page = 1;
        applyFiltersAndRender();
      });
      prevBtn.addEventListener('click', () => { if (page > 1) { page--; render(); } });
      nextBtn.addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(viewRows.length / pageSize)); if (page < totalPages) { page++; render(); } });
    }

    let filterTimer = null;
    function onFilterChange() {
      if (filterTimer) clearTimeout(filterTimer);
      filterTimer = setTimeout(() => { page = 1; applyFiltersAndRender(); }, 80);
    }

    function applyFiltersAndRender() {
      const g = genderSelect.value;
      const a = ageSelect.value;
      const b = bodySelect.value;
      const c = conditionsSelect.value;
      const q = searchInput.value.trim().toLowerCase();

      viewRows = rawRows.filter(r => {
        if (g) {
          const rg = r._gender || (r['gender'] ? r['gender'].toString().toLowerCase() : '');
          if (g === 'unknown') { if (rg !== 'unknown') return false; }
          else if (rg !== g) { return false; }
        }
        if (!inAgeBin(r._age, a)) return false;
        if (b && !r._bodies.has(b)) return false;
        if (c && !r._conds.has(c)) return false;
        if (q) {
          const hay = (r._caption + ' ' + (r._username || '') + ' ' + (r['condition'] || '') + ' ' + (r['body_part'] || '')).toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return r._post; // must have a post URL to embed
      });

      // Randomize order for a fresh feel
      viewRows = shuffle(viewRows.slice());
      render();
    }

    function render() {
      const total = viewRows.length;
      counter.textContent = total.toLocaleString();
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (page > totalPages) page = totalPages;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const pageRows = viewRows.slice(start, end);

      pageInfo.textContent = `Page ${page} / ${totalPages}`;
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= totalPages;

      // Build embed HTML. Note: Instagram's embed script will convert blockquotes into iframes.
      grid.innerHTML = pageRows.map(r => {
        const url = r._post;
        // Optional: include a minimal fallback link inside the blockquote for non-JS
        return `
          <div class="embed-card">
            <blockquote class="instagram-media" data-instgrm-permalink="${url}" data-instgrm-version="14">
              <a href="${url}" target="_blank" rel="noopener">View on Instagram</a>
            </blockquote>
          </div>
        `;
      }).join('');

      // Ask Instagram to (re)process new embeds
      if (window.instgrm && window.instgrm.Embeds && typeof window.instgrm.Embeds.process === 'function') {
        try { window.instgrm.Embeds.process(); } catch (e) { console.warn('instgrm process failed:', e); }
      }
    }
  </script>
</body>
</html>